# Dumall 微服务部署方案

## 📋 部署方案概述

本文档提供了Dumall微服务系统的完整部署方案，包括开发、测试和生产环境的部署策略。

## 🏗️ 系统架构

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│   React 前端    │    │   Nginx 网关    │    │   Spring Boot   │
│   (5174端口)    │◄──►│   (80端口)      │◄──►│   微服务集群     │
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │
                                ▼
                    ┌─────────────────┐
                    │   监控系统       │
                    │ Prometheus +    │
                    │ Grafana         │
                    └─────────────────┘
```

## 🚀 部署方案

### 方案一：Docker容器化部署（推荐）

#### 1. 环境要求
- Docker 20.10+
- Docker Compose 2.0+
- 至少4GB内存
- 至少20GB磁盘空间

#### 2. 快速部署
```bash
# 克隆项目
git clone https://github.com/hackwoman/dumall-micro.git
cd dumall-micro

# 给部署脚本执行权限
chmod +x deploy.sh

# 开发环境部署
./deploy.sh development

# 生产环境部署
./deploy.sh production v1.0.0 your-registry.com
```

#### 3. 手动部署步骤
```bash
# 1. 构建公共模块
cd dumall-common && mvn clean install -DskipTests

# 2. 构建所有微服务
for service in user-service product-service payment-service inventory-service; do
  cd $service && mvn clean package -DskipTests && cd ..
done

# 3. 构建Docker镜像
docker-compose build

# 4. 启动服务
docker-compose up -d

# 5. 检查服务状态
docker-compose ps
```

#### 4. 服务管理
```bash
# 查看日志
docker-compose logs -f [service-name]

# 重启服务
docker-compose restart [service-name]

# 停止所有服务
docker-compose down

# 更新服务
docker-compose pull && docker-compose up -d
```

### 方案二：Kubernetes部署

#### 1. 环境要求
- Kubernetes 1.20+
- kubectl 1.20+
- Helm 3.0+（可选）

#### 2. 部署步骤
```bash
# 1. 创建命名空间
kubectl apply -f k8s/namespace.yaml

# 2. 创建配置
kubectl apply -f k8s/configmap.yaml
kubectl apply -f k8s/secret.yaml

# 3. 部署服务
kubectl apply -f k8s/user-service.yaml
kubectl apply -f k8s/product-service.yaml
kubectl apply -f k8s/payment-service.yaml
kubectl apply -f k8s/inventory-service.yaml

# 4. 部署前端
kubectl apply -f k8s/frontend.yaml

# 5. 部署网关
kubectl apply -f k8s/nginx-gateway.yaml
```

#### 3. 服务管理
```bash
# 查看Pod状态
kubectl get pods -n dumall

# 查看服务状态
kubectl get services -n dumall

# 查看日志
kubectl logs -f deployment/user-service -n dumall

# 扩缩容
kubectl scale deployment user-service --replicas=3 -n dumall
```

### 方案三：传统服务器部署

#### 1. 环境要求
- Java 17+
- Node.js 18+
- Maven 3.8+
- Nginx 1.20+

#### 2. 部署步骤
```bash
# 1. 构建后端服务
cd dumall-common && mvn clean install -DskipTests
cd ../user-service && mvn clean package -DskipTests
cd ../product-service && mvn clean package -DskipTests
cd ../payment-service && mvn clean package -DskipTests
cd ../inventory-service && mvn clean package -DskipTests

# 2. 启动后端服务
nohup java -jar user-service/target/*.jar > user-service.log 2>&1 &
nohup java -jar product-service/target/*.jar > product-service.log 2>&1 &
nohup java -jar payment-service/target/*.jar > payment-service.log 2>&1 &
nohup java -jar inventory-service/target/*.jar > inventory-service.log 2>&1 &

# 3. 构建前端
cd frontend && npm install && npm run build

# 4. 配置Nginx
sudo cp nginx-gateway.conf /etc/nginx/nginx.conf
sudo nginx -t && sudo systemctl restart nginx
```

## 🔧 环境配置

### 开发环境
- 使用H2内存数据库
- 开启调试日志
- 禁用安全限制

### 测试环境
- 使用PostgreSQL数据库
- 开启监控
- 基本安全配置

### 生产环境
- 使用PostgreSQL集群
- 完整的监控和日志
- 严格的安全配置
- SSL/TLS加密

## 📊 监控和日志

### 监控系统
- **Prometheus**: 指标收集
- **Grafana**: 可视化面板
- **健康检查**: 自动检测服务状态

### 日志管理
- 结构化日志输出
- 日志轮转
- 错误告警

### 访问监控地址
- Prometheus: http://localhost:9090
- Grafana: http://localhost:3000 (admin/admin123)

## 🔐 安全配置

### 1. 网络安全
- 防火墙配置
- 端口限制
- SSL/TLS证书

### 2. 应用安全
- JWT令牌验证
- API密钥管理
- 输入验证

### 3. 数据安全
- 数据库加密
- 备份策略
- 访问控制

## 📈 性能优化

### 1. 应用优化
- JVM参数调优
- 连接池配置
- 缓存策略

### 2. 基础设施优化
- 负载均衡
- 自动扩缩容
- 资源限制

## 🚨 故障处理

### 1. 常见问题
- 服务启动失败
- 数据库连接问题
- 内存不足

### 2. 故障排查
```bash
# 检查服务状态
docker-compose ps
kubectl get pods -n dumall

# 查看日志
docker-compose logs -f [service-name]
kubectl logs -f deployment/[service-name] -n dumall

# 健康检查
curl http://localhost:8081/actuator/health
```

### 3. 恢复策略
- 自动重启
- 回滚机制
- 数据备份恢复

## 🔄 CI/CD流水线

### GitHub Actions
- 自动测试
- 镜像构建
- 自动部署

### 部署流程
1. 代码提交触发流水线
2. 运行单元测试
3. 构建Docker镜像
4. 推送到镜像仓库
5. 部署到测试环境
6. 运行集成测试
7. 部署到生产环境

## 📝 部署检查清单

### 部署前检查
- [ ] 代码审查通过
- [ ] 测试用例通过
- [ ] 环境配置正确
- [ ] 数据库备份完成
- [ ] 监控系统就绪

### 部署后检查
- [ ] 所有服务正常启动
- [ ] 健康检查通过
- [ ] 功能测试通过
- [ ] 性能指标正常
- [ ] 日志输出正常

## 🎯 最佳实践

### 1. 部署策略
- 蓝绿部署
- 滚动更新
- 金丝雀发布

### 2. 版本管理
- 语义化版本
- 镜像标签策略
- 回滚机制

### 3. 配置管理
- 环境变量
- 配置文件
- 密钥管理

## 📞 技术支持

### 联系方式
- 项目维护者: hackwoman
- 项目地址: https://github.com/hackwoman/dumall-micro

### 文档资源
- API文档: http://localhost:8081/swagger-ui.html
- 监控面板: http://localhost:3000
- 健康检查: http://localhost:8081/actuator/health

---

**最后更新**: 2025-08-02
**版本**: 1.0.0 